{% extends "base.html" %}
{% block title %}CCTV ìƒì„¸ ë³´ê¸°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_cctv.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<style>
    .led-controls {
        margin-top: 20px;
        background-color: #f1f1f1;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .led-controls h3 {
        margin-bottom: 10px;
        font-size: 18px;
        color: #333;
    }
    .led-buttons button {
        padding: 10px 20px;
        margin-right: 10px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #004d99;
        color: white;
        transition: background-color 0.3s;
    }
    .led-buttons button:hover {
        background-color: #003366;
    }
</style>
{% endblock %}

{% block content %}
<main class="content-area">
    <div class="cctv-container">
        <div class="cctv-header">
            <div class="cctv-title">
                <h1>ğŸ“¹ {{ camera.location }} CCTV</h1>
                <div class="location-timestamp" id="current-time">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="cctv-status">
                <span class="status-badge live">ì‹¤ì‹œê°„</span>
                <span class="status-indicator"></span>
            </div>
        </div>

        <div class="cctv-main">
            <div class="cctv-stream-container">
                <div class="cctv-stream">
                    <img id="video-stream" src="http://{{camera.cctv_ip}}:5000/stream" alt="CCTV Stream">
                    <div class="stream-overlay">
                        <div class="overlay-top">
                            <span class="camera-id">ê°€ë¡œë“± ë²ˆí˜¸: {{ camera.street_light_id }}</span>
                            <span class="timestamp">{{ camera.location }}</span>
                        </div>
                    </div>
                </div>

                <div class="stream-controls">
                    <button class="control-btn fullscreen-btn" title="ì „ì²´ í™”ë©´">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="control-btn snapshot-btn" title="ìŠ¤í¬ë¦°ìƒ·">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>

            </div>

            <div class="cctv-sidebar">
                <div class="info-card">
                    <h2>CCTV ì •ë³´</h2>
                    <ul class="info-list">
                        <li><strong>ìœ„ì¹˜:</strong> {{ camera.location }}</li>
                        <li><strong>ìš©ë„:</strong> {{ camera.purpose }}</li>
                        <li><strong>ì„¤ì¹˜ì¼:</strong> 2025-03-18</li>
                        <li><strong>ëª¨ë¸:</strong> ESP32-CAM</li>
                        <li><strong>IP ì£¼ì†Œ:</strong> {{ camera.cctv_ip }}</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h2>ğŸ’¡ ê°€ë¡œë“± ì œì–´</h2>
                    <div class="led-buttons">
                        <button onclick="sendCommand('arduino{{ camera.street_light_id }}', 'LED_ON')">LED ON</button>
                        <button onclick="sendCommand('arduino{{ camera.street_light_id }}', 'LED_OFF')">LED OFF</button>
                        <button onclick="sendCommand('arduino{{ camera.street_light_id }}', 'AUTO_MODE')">AUTO MODE</button>
                    </div>
                </div>

                <div class="info-card sensor-data">
                    <h2>ì„¼ì„œ ë°ì´í„°</h2>
                    <div class="sensor-status" id="safety-status">
                        <i class="fas fa-shield-alt"></i> <span id="status-text">                      
                            {% if malfunction_status %}
                                {% if malfunction_status.reason_led and malfunction_status.reason_tilt %}
                                    í˜„ì¬ ê°€ë¡œë“± ìƒíƒœ : LED ê³ ì¥, ê¸°ìš¸ì–´ì§
                                {% elif malfunction_status.reason_led %}
                                    í˜„ì¬ ê°€ë¡œë“± ìƒíƒœ : LED ê³ ì¥
                                {% elif malfunction_status.reason_tilt %}
                                    í˜„ì¬ ê°€ë¡œë“± ìƒíƒœ : ê¸°ìš¸ì–´ì§
                                {% else %}
                                    í˜„ì¬ ê°€ë¡œë“± ìƒíƒœ : ìƒíƒœ ì´ìƒ
                                {% endif %}
                            {% else %}
                                í˜„ì¬ ê°€ë¡œë“± ìƒíƒœ : ì–‘í˜¸
                            {% endif %}</span>

                    </div>
                    <div class="sensor-readings">
                        <div class="sensor-reading" id="temperature-reading">
                            <i class="fas fa-thermometer-half"></i>
                            <span>{{ sensor_data.temperature if sensor_data else "-" }}Â°C</span>
                        </div>
                        <div class="sensor-reading" id="humidity-reading">
                            <i class="fas fa-tint"></i>
                            <span>{{ sensor_data.humidity if sensor_data else "-" }}%</span>
                        </div>
                        <div class="sensor-reading" id="heat-index-reading">
                            <i class="fas fa-temperature-high"></i>
                            <span>{{ sensor_data.perceived_temperature if sensor_data else "-" }}Â°C</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ì±„íŒ… ìœ„ì ¯ ì¶”ê°€ -->
    {% include 'public/chat_widget.html' %}
</main>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/view_cctv.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    function sendCommand(target, cmd) {
        fetch(`/set_command?target=${target}&cmd=${cmd}`)
        .then(response => response.json())
        .then(data => {
            alert(`ëª…ë ¹ ì „ì†¡ë¨: ${target} - ${cmd}`);
            console.log("LED Command Sent:", data);
        })
        .catch(error => console.error("LED Command Error:", error));
    }
</script>
{% endblock %}